---
import type { Media, Post } from "@/lib/payloadTypes";
import { formatDateTime } from "@/utils/formatDateTime";
import { Link } from "@/components/Link";
import { formatAuthors } from "@/utils/formatAuthors";

interface Props {
    post: Post;
    index?: number;
    hasCategories?: boolean;
    hasTags?: boolean;
}

const { post, index, hasCategories, hasTags } = Astro.props;

const { meta, slug, categories, tags, publishedAt, populatedAuthors, title } =
    post;

const { description, image: metaImage } = meta || {};
const url = (metaImage as Media)?.unpicUrl || "";

const hasPopularAuthors =
    populatedAuthors &&
    Array.isArray(populatedAuthors) &&
    populatedAuthors.length > 0;

const href = `/blog/post/${slug}`;
---

<article
    class="group relative bg-section-color dark:bg-section-color rounded-lg shadow-lg hover:shadow-2xl transition-all duration-500 overflow-hidden cursor-pointer transform hover:-translate-y-2 flex flex-col h-full"
    onClick={(e) => {
        if (!(e.target as HTMLElement).closest("a")) {
            window.location.href = href;
        }
    }}
    style={{
        animation: "fadeInUp 0.6s ease-out",
        animationDelay: `${index * 100}ms`,
        animationFillMode: "backwards",
    }}
>
    <!-- Imagen / portada -->
    <div class="relative h-56 overflow-hidden">
        <div
            class="absolute inset-0 bg-cover transform group-hover:scale-110 transition-transform duration-700"
            style={{
                backgroundImage:
                    metaImage && typeof metaImage !== "string"
                        ? `url(${url})`
                        : "none",
                backgroundColor: !metaImage ? "#e5e7eb" : undefined,
            }}
        >
            {
                !metaImage && (
                    <div class="flex items-center justify-center h-full text-gray-400">
                        <svg
                            class="w-20 h-20"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width={1}
                                d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                            />
                        </svg>
                    </div>
                )
            }
        </div>
        <div
            class="absolute inset-0 bg-gradient-to-t from-black/60 via-black/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"
        >
        </div>
    </div>

    <!-- Contenido -->
    <div class="px-6 pt-6 pb-6 flex flex-col flex-grow">
        <!-- Autores y fecha -->
        <div
            class="flex items-center gap-4 text-xs text-gray-500 dark:text-gray-400 mb-4"
        >
            {
                hasPopularAuthors && (
                    <div class="flex items-center gap-1.5">
                        <svg
                            class="w-4 h-4"
                            fill="currentColor"
                            viewBox="0 0 20 20"
                        >
                            <path
                                fill-rule="evenodd"
                                d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"
                                clip-rule="evenodd"
                            />
                        </svg>
                        <span class="font-medium">
                            {formatAuthors(populatedAuthors)}
                        </span>
                    </div>
                )
            }
            {
                publishedAt && (
                    <div class="flex items-center gap-1.5">
                        <svg
                            class="w-4 h-4"
                            fill="currentColor"
                            viewBox="0 0 20 20"
                        >
                            <path
                                fill-rule="evenodd"
                                d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"
                                clip-rule="evenodd"
                            />
                        </svg>
                        <time date-time={publishedAt.toString()}>
                            {formatDateTime(publishedAt)}
                        </time>
                    </div>
                )
            }
        </div>

        <!-- Título -->
        <h3
            class="text-xl font-bold text-gray-900 dark:text-white line-clamp-2 dark:group-hover:text-indigo-400 transition-colors"
        >
            {title}
        </h3>

        <!-- Descripción -->
        <p
            class="text-sm text-gray-600 dark:text-gray-300 line-clamp-3 leading-relaxed mt-2 flex-grow"
        >
            {description}
        </p>

        <!-- Categorías y tags -->
        <div class="flex flex-wrap gap-2 pt-2 mt-auto">
            {
                hasCategories &&
                    categories?.slice(0, 2).map(
                        (category) =>
                            typeof category === "object" &&
                            category && (
                                <Link url={`/blog/category/${category.slug!}`}>
                                    <span class="inline-flex items-center gap-1 px-3 py-1 bg-primary dark:bg-blue-900/30 text-[#0e3734] dark:text-blue-300 rounded-full text-xs font-medium hover:bg-blue-200 dark:hover:bg-blue-900/50 transition-colors">
                                        <svg
                                            class="w-3 h-3"
                                            fill="currentColor"
                                            viewBox="0 0 20 20"
                                        >
                                            <path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" />
                                        </svg>
                                        {category.title}
                                    </span>
                                </Link>
                            ),
                    )
            }
            {
                hasTags &&
                    tags?.slice(0, 2).map(
                        (tag) =>
                            typeof tag === "object" &&
                            tag && (
                                <Link
                                    url={`/blog/tag/${encodeURIComponent(tag.slug!)}`}
                                >
                                    <span class="inline-flex items-center gap-1 px-3 py-1 bg-yellow-neutral dark:bg-[emerald-900/3] text-[#513c0e] dark:text-emerald-300 rounded-full text-xs font-medium hover:bg-emerald-200 dark:hover:bg-emerald-900/50 transition-colors">
                                        #{tag.title}
                                    </span>
                                </Link>
                            ),
                    )
            }
        </div>
    </div>

    <!-- Icono de flecha -->
    <div
        class="absolute bottom-4 right-6 opacity-0 group-hover:opacity-100 transform translate-x-2 group-hover:translate-x-0 transition-all duration-300"
    >
        <div class="bg-primary text-white rounded-full p-2 shadow-lg">
            <svg
                class="w-5 h-5"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width={2}
                    d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
            </svg>
        </div>
    </div>
</article>
