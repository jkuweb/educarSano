---
import PostCard from "@/components/PostCard/PostCard.astro";
import type { PayloadResponse, Post } from "@/lib/payloadTypes";
import { payloadFetch } from "@/utils/payloadFetch";

// Trae los Ãºltimos 10 posts
const response = await payloadFetch<PayloadResponse<Post>>(
    `/posts?limit=10&sort=-publishedAt&depth=2`,
);
const posts = response.docs;
---

<section
    class="relative w-full overflow-hidden py-20 bg-gradient-to-b from-slate-50 to-white dark:from-gray-900 dark:to-gray-800"
>
    <div class="text-center mb-10">
        <h2 class="text-4xl font-extrabold text-gray-900 dark:text-white mb-2">
            ðŸŒ€ Ãšltimos Posts
        </h2>
        <p class="text-gray-600 dark:text-gray-400 text-sm">
            Explora las Ãºltimas novedades de nuestro blog
        </p>
    </div>

    <div
        id="carousel-wrapper"
        class="relative mx-auto max-w-7xl overflow-hidden"
    >
        <!-- Carrusel -->
        <div
            id="carousel"
            class="flex gap-8 transition-transform duration-700 ease-out will-change-transform"
        >
            {
                posts.map((post, index) => (
                    <div class="flex-shrink-0 w-full sm:w-1/2 lg:w-1/3">
                        <PostCard
                            post={post}
                            index={index}
                            hasCategories={post.categories.length > 0}
                            hasTags={post.tags.length > 0}
                        />
                    </div>
                ))
            }
        </div>

        <!-- Botones -->
        <button
            id="prevBtn"
            class="absolute left-4 top-1/2 -translate-y-1/2 bg-white/80 dark:bg-gray-700/70 backdrop-blur-sm shadow-lg hover:shadow-xl rounded-full w-12 h-12 flex items-center justify-center transition-transform hover:scale-105 z-10"
            aria-label="Anterior"
        >
            <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-6 h-6 text-gray-800 dark:text-gray-100"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 19l-7-7 7-7"></path>
            </svg>
        </button>

        <button
            id="nextBtn"
            class="absolute right-4 top-1/2 -translate-y-1/2 bg-white/80 dark:bg-gray-700/70 backdrop-blur-sm shadow-lg hover:shadow-xl rounded-full w-12 h-12 flex items-center justify-center transition-transform hover:scale-105 z-10"
            aria-label="Siguiente"
        >
            <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-6 h-6 text-gray-800 dark:text-gray-100"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5l7 7-7 7"></path>
            </svg>
        </button>
    </div>

    <!-- Indicadores -->
    <div id="indicators" class="flex justify-center gap-2 mt-8">
        {
            Array.from({ length: Math.ceil(posts.length / 3) }).map((_, i) => (
                <span
                    class="w-3 h-3 rounded-full bg-gray-300 dark:bg-gray-600 transition-all duration-300"
                    data-index={i}
                />
            ))
        }
    </div>

    <!-- GSAP -->
    <script>
        import gsap from "gsap";

        const carousel = document.querySelector("#carousel");
        const slides = Array.from(carousel.children);
        const prev = document.querySelector("#prevBtn");
        const next = document.querySelector("#nextBtn");
        const indicators = Array.from(
            document.querySelectorAll("#indicators span"),
        );

        let groupIndex = 0;
        let visibleSlides = 3;
        let groupCount = Math.ceil(slides.length / visibleSlides);
        let slideWidth = 0;
        let isAnimating = false;

        function updateVisibleSlides() {
            if (window.innerWidth < 640) visibleSlides = 1;
            else if (window.innerWidth < 1024) visibleSlides = 2;
            else visibleSlides = 3;

            groupCount = Math.ceil(slides.length / visibleSlides);
            const firstSlide = slides[0];
            if (firstSlide) {
                slideWidth = firstSlide.getBoundingClientRect().width + 32; // 32px gap
            }
        }

        function updateIndicators() {
            indicators.forEach((dot, i) => {
                dot.classList.toggle("bg-indigo-500", i === groupIndex);
                dot.classList.toggle("scale-125", i === groupIndex);
            });
        }

        function goToGroup(newIndex) {
            if (isAnimating) return;
            isAnimating = true;

            groupIndex = (newIndex + groupCount) % groupCount;
            const offset = -(groupIndex * visibleSlides * slideWidth);

            gsap.to(carousel, {
                x: offset,
                duration: 1,
                ease: "power3.inOut",
                onComplete: () => (isAnimating = false),
            });

            updateIndicators();
        }

        prev.addEventListener("click", () => goToGroup(groupIndex - 1));
        next.addEventListener("click", () => goToGroup(groupIndex + 1));

        // autoplay
        let autoplay = setInterval(() => goToGroup(groupIndex + 1), 6000);
        carousel.addEventListener("mouseenter", () => clearInterval(autoplay));
        carousel.addEventListener("mouseleave", () => {
            autoplay = setInterval(() => goToGroup(groupIndex + 1), 6000);
        });

        window.addEventListener("resize", () => {
            updateVisibleSlides();
            goToGroup(groupIndex);
        });

        window.addEventListener("load", () => {
            updateVisibleSlides();
            goToGroup(0);
        });

        updateVisibleSlides();
        updateIndicators();
    </script>
</section>
