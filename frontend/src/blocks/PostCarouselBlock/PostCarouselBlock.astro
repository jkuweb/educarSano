---
import AsteriskIcon from "@/components/AsteriskIcon/AsteriskIcon.astro";
import PostCard from "@/components/PostCard/PostCard.astro";
import { Separator } from "@/components/Separator/Separator";
import type { PayloadResponse, Post } from "@/lib/payloadTypes";
import { payloadFetch } from "@/utils/payloadFetch";
import type { PostCarouselBlock as PostCarouselBlockProps } from "@/lib/payloadTypes";
import { cn } from "@/utils/ui";

const response = await payloadFetch<PayloadResponse<Post>>(
    `/posts?limit=10&sort=-publishedAt&depth=2`,
);

const { bottom, isReverse, separatorType, enableBackgroundImage, darkMode } =
    Astro.props as PostCarouselBlockProps;
const posts = response.docs;
const hasPosts = posts && posts.length > 0;
---

<section
    class={cn(
        "relative z-10 w-full overflow-hidden py-20 bg-white  pb-40 pt-40",
        enableBackgroundImage ? "bg-section" : "",
        darkMode === "blue"
            ? "dark:bg-section-color-blue"
            : "dark:bg-section-color",
    )}
>
    <div class="text-center m-10 lg:m-32">
        <div class="flex justify-center items-center gap-4">
            <AsteriskIcon className="w-8 relative top-[-16px] left-[11px]" />
            <h2
                class="text-4xl font-extrabold text-gray-900 dark:text-white !mb-0"
            >
                Ãšltimos Posts
            </h2>
        </div>
    </div>

    <div
        id="carousel-wrapper"
        class="relative mx-auto max-w-7xl overflow-hidden px-4 py-8"
    >
        <div
            id="carousel"
            class="flex gap-8 transition-transform duration-700 ease-out will-change-transform"
        >
            {
                hasPosts &&
                    posts.map((post, index) => (
                        <div class="flex-shrink-0 w-full sm:w-1/2 lg:w-1/3">
                            <PostCard
                                post={post}
                                index={index}
                                hasCategories={post.categories.length > 0}
                                hasTags={post.tags.length > 0}
                            />
                        </div>
                    ))
            }
        </div>

        <button
            id="prevBtn"
            class="absolute left-4 top-[95%] sm:top-1/2 -translate-y-1/2 bg-white/80 dark:bg-gray-700/70 backdrop-blur-sm shadow-lg hover:shadow-xl rounded-full w-12 h-12 flex items-center justify-center transition-transform hover:scale-105 z-10"
            aria-label="Anterior"
        >
            <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-6 h-6 text-gray-800 dark:text-gray-100"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 19l-7-7 7-7"></path>
            </svg>
        </button>

        <button
            id="nextBtn"
            class="absolute right-4 top-[95%] sm:top-1/2 -translate-y-1/2 bg-white/80 dark:bg-gray-700/70 backdrop-blur-sm shadow-lg hover:shadow-xl rounded-full w-12 h-12 flex items-center justify-center transition-transform hover:scale-105 z-10"
            aria-label="Siguiente"
        >
            <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-6 h-6 text-gray-800 dark:text-gray-100"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5l7 7-7 7"></path>
            </svg>
        </button>
    </div>

    <div id="indicators" class="flex justify-center gap-2 mt-8">
        {
            Array.from({ length: Math.ceil(posts.length / 3) }).map((_, i) => (
                <span
                    class="w-3 h-3 rounded-full bg-gray-300 dark:bg-gray-600 transition-all duration-300"
                    data-index={i}
                />
            ))
        }
    </div>

    <Separator
        type={separatorType || "separatorWhite"}
        reverse={isReverse}
        className={cn(
            "absolute",
            darkMode === "dark"
                ? "dark:[&>path]:fill-section-color-blue"
                : "dark:[&>path]:fill-section-color",
        )}
        style={{ bottom: `${bottom}px` }}
    />
</section>
<script>
    import gsap from "gsap";

    const carousel = document.querySelector("#carousel");
    const slides = Array.from(carousel.children);
    const prev = document.querySelector("#prevBtn");
    const next = document.querySelector("#nextBtn");
    const indicators = Array.from(
        document.querySelectorAll("#indicators span"),
    );

    let groupIndex = 0;
    let visibleSlides = 3;
    let groupCount = Math.ceil(slides.length / visibleSlides);
    let slideWidth = 0;
    let isAnimating = false;

    function updateVisibleSlides() {
        if (window.innerWidth < 640) visibleSlides = 1;
        else if (window.innerWidth < 1024) visibleSlides = 2;
        else visibleSlides = 3;

        groupCount = Math.ceil(slides.length / visibleSlides);
        const firstSlide = slides[0];
        if (firstSlide) {
            slideWidth = firstSlide.getBoundingClientRect().width + 32;
        }
    }

    function updateIndicators() {
        indicators.forEach((dot, i) => {
            dot.classList.toggle("bg-primary", i === groupIndex);
            dot.classList.toggle("scale-125", i === groupIndex);
        });
    }

    function goToGroup(newIndex) {
        if (isAnimating) return;
        isAnimating = true;

        groupIndex = (newIndex + groupCount) % groupCount;
        const offset = -(groupIndex * visibleSlides * slideWidth);

        gsap.to(carousel, {
            x: offset,
            duration: 1,
            ease: "power3.inOut",
            onComplete: () => (isAnimating = false),
        });

        updateIndicators();
    }

    prev.addEventListener("click", () => goToGroup(groupIndex - 1));
    next.addEventListener("click", () => goToGroup(groupIndex + 1));

    // autoplay
    let autoplay = setInterval(() => goToGroup(groupIndex + 1), 6000);
    carousel.addEventListener("mouseenter", () => clearInterval(autoplay));
    carousel.addEventListener("mouseleave", () => {
        autoplay = setInterval(() => goToGroup(groupIndex + 1), 6000);
    });

    window.addEventListener("resize", () => {
        updateVisibleSlides();
        goToGroup(groupIndex);
    });

    window.addEventListener("load", () => {
        updateVisibleSlides();
        goToGroup(0);
    });

    updateVisibleSlides();
    updateIndicators();
</script>
